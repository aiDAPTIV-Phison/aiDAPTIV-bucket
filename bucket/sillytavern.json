{
  "version": "1.13.5",
  "description": "SillyTavern - LLM Frontend for Power Users. Integrating aiDAPTIV+ Middleware with Open-Source Softwares.",
  "homepage": "https://github.com/aiDAPTIV-Phison/aiDAPTIV-Integration-SillyTavern",
  "url": [
    "https://github.com/aiDAPTIV-Phison/aiDAPTIV-Integration-SillyTavern/archive/refs/heads/release.zip",
    "https://github.com/aiDAPTIV-Phison/aiDAPTIV-bucket/raw/refs/heads/main/sillytavern/start.ps1",
    "https://github.com/aiDAPTIV-Phison/aiDAPTIV-bucket/raw/refs/heads/main/sillytavern/stop.ps1",
    "https://github.com/aiDAPTIV-Phison/aiDAPTIV-bucket/raw/refs/heads/main/sillytavern/status.ps1",
    "http://192.168.54.46:18301/SillyTavern_kvcache.zip"
  ],
  "hash": [
    "8c4161c0c8065e41ea418cf05e8f5aac831a926e2e30208cb82161e23ef59284",
    "7b5c5350a43d35be07d681171fb10b302f09be7134e83ae6b5c94692e8641161",
    "a713c2b2645febc087109ebb713b526fba8753415d568ad3d1b3e57a2943ed04",
    "80ba98333a4cab47fc1a6008c19378cee37883333233989bb552d43dc1d35749",
    "3a139eec0733630259e780ce0e1f13307345b4827db843217d379acd35323c1d"
  ],
  "installer": {
    "script": [
      "# Extract the zip file (if not already extracted by Scoop)",
      "$releaseZipPath = Join-Path $dir 'release.zip'",
      "if (Test-Path $releaseZipPath) {",
      "    # Scoop hasn't auto-extracted, we need to extract it manually",
      "    Expand-Archive -Path $releaseZipPath -DestinationPath \"$dir\\temp_extract\" -Force",
      "    $extractedFolder = Get-ChildItem -Path \"$dir\\temp_extract\" -Directory | Select-Object -First 1",
      "    if ($extractedFolder) {",
      "        Move-Item -Path \"$extractedFolder\\*\" -Destination $dir -Force",
      "        Remove-Item -Path \"$dir\\temp_extract\" -Recurse -Force -ErrorAction SilentlyContinue",
      "    }",
      "    Remove-Item -Path $releaseZipPath -Force -ErrorAction SilentlyContinue",
      "} else {",
      "    # Scoop has already extracted the zip, check if content needs to be moved from subdirectory",
      "    $subDirs = Get-ChildItem -Path $dir -Directory -Filter 'aiDAPTIV-Integration-SillyTavern-*' | Select-Object -First 1",
      "    if ($subDirs) {",
      "        # Content was extracted to a subdirectory, move it to $dir",
      "        Move-Item -Path \"$($subDirs.FullName)\\*\" -Destination $dir -Force",
      "        Remove-Item -Path $subDirs.FullName -Recurse -Force -ErrorAction SilentlyContinue",
      "    }",
      "}",
      "",
      "# Download config.txt to get port configuration",
      "$configUrl = 'https://github.com/aiDAPTIV-Phison/aiDAPTIV-bucket/raw/refs/heads/main/sillytavern/config.txt'",
      "$configPath = Join-Path $dir 'config.txt'",
      "$port = 8000",
      "try {",
      "    Invoke-WebRequest -Uri $configUrl -OutFile $configPath -ErrorAction Stop",
      "    $configContent = Get-Content $configPath -Raw",
      "    if ($configContent -match 'port[\\s=:]+(\\d+)') {",
      "        $port = [int]$matches[1]",
      "    }",
      "} catch {",
      "    Write-Warning 'Failed to download config.txt, using default port 8000'",
      "    # Create default config.txt",
      "    Set-Content -Path $configPath -Value 'port=8000'",
      "}",
      "",
      "# Update config.yaml with port from config.txt",
      "$configYamlPath = Join-Path $dir 'config.yaml'",
      "if (Test-Path $configYamlPath) {",
      "    $configYaml = Get-Content $configYamlPath -Raw",
      "    $configYaml = $configYaml -replace 'port:\\s*\\d+', \"port: $port\"",
      "    Set-Content -Path $configYamlPath -Value $configYaml -NoNewline",
      "}",
      "",
      "# Check if Node.js is installed",
      "$nodePath = Get-Command node -ErrorAction SilentlyContinue",
      "if (-not $nodePath) {",
      "    Write-Error 'Node.js not found. Please install Node.js 18+ first. You can download it from: https://nodejs.org/'",
      "    exit 1",
      "}",
      "",
      "# Install npm dependencies",
      "Set-Location $dir",
      "$env:NODE_ENV = 'production'",
      "& npm install --no-audit --no-fund --loglevel=error --no-progress --omit=dev",
      "",
      "# Ensure start.ps1, stop.ps1, status.ps1 are in $dir",
      "# These files should be downloaded from url array, but verify they exist",
      "if (-not (Test-Path \"$dir\\start.ps1\")) {",
      "    Write-Warning 'start.ps1 not found in $dir'",
      "}",
      "if (-not (Test-Path \"$dir\\stop.ps1\")) {",
      "    Write-Warning 'stop.ps1 not found in $dir'",
      "}",
      "if (-not (Test-Path \"$dir\\status.ps1\")) {",
      "    Write-Warning 'status.ps1 not found in $dir'",
      "}",
      "",
      "# Note: LLM endpoint (http://127.0.0.1:13141) needs to be configured",
      "# in SillyTavern UI after first launch, as it's stored in user settings"
    ]
  },
  "pre_install": [],
  "post_install": [
    "# Ensure data directory exists",
    "New-Item -ItemType Directory -Force -Path \"$dir\\data\" | Out-Null",
    "",
    "# Preset LLM endpoint in default user settings",
    "$defaultUserDir = Join-Path \"$dir\\data\" 'default-user'",
    "$settingsPath = Join-Path $defaultUserDir 'settings.json'",
    "if (Test-Path $settingsPath) {",
    "    $settings = Get-Content $settingsPath -Raw | ConvertFrom-Json",
    "    # Set default LLM endpoint to http://127.0.0.1:13141",
    "    # This will be used when Custom API is selected",
    "    if (-not $settings.api_server) {",
    "        $settings | Add-Member -MemberType NoteProperty -Name 'api_server' -Value 'http://127.0.0.1:13141' -Force",
    "    } else {",
    "        $settings.api_server = 'http://127.0.0.1:13141'",
    "    }",
    "    $settings | ConvertTo-Json -Depth 100 | Set-Content -Path $settingsPath -NoNewline",
    "}",
    "",
    "# Extract SillyTavern_kvcache.zip to R drive root",
    "$kvcacheZip = Join-Path $dir 'SillyTavern_kvcache.zip'",
    "$rDriveRoot = 'R:\\'",
    "",
    "# Check if R drive exists",
    "$rDriveExists = Test-Path $rDriveRoot",
    "if (-not $rDriveExists) {",
    "    Write-Warning 'R drive does not exist. Skipping kvcache extraction.'",
    "} else {",
    "    $tempExtractPath = $null",
    "    $sourcePath = $null",
    "",
    "    if (Test-Path $kvcacheZip) {",
    "        # Zip file exists, extract it to temp directory",
    "        $tempExtractPath = Join-Path $dir 'SillyTavern_kvcache_temp'",
    "        try {",
    "            Expand-Archive -Path $kvcacheZip -DestinationPath $tempExtractPath -Force",
    "            # Find the extracted content (could be in a subdirectory or directly in temp)",
    "            $extractedFolders = Get-ChildItem -Path $tempExtractPath -Directory",
    "            if ($extractedFolders.Count -eq 1) {",
    "                # Single folder, use its contents",
    "                $sourcePath = $extractedFolders[0].FullName",
    "            } else {",
    "                # Multiple folders or files directly, use temp directory itself",
    "                $sourcePath = $tempExtractPath",
    "            }",
    "        } catch {",
    "            Write-Warning \"Failed to extract SillyTavern_kvcache.zip: $_\"",
    "            if (Test-Path $tempExtractPath) {",
    "                Remove-Item -Path $tempExtractPath -Recurse -Force -ErrorAction SilentlyContinue",
    "            }",
    "        }",
    "    } else {",
    "        # Zip file doesn't exist, check if Scoop already extracted it",
    "        # Scoop may extract to a subdirectory or directly to $dir",
    "        $extractedKvcacheDir = Get-ChildItem -Path $dir -Directory -Filter 'SillyTavern_kvcache*' | Select-Object -First 1",
    "        if ($extractedKvcacheDir) {",
    "            # Found extracted directory (Scoop created a subdirectory)",
    "            $sourcePath = $extractedKvcacheDir.FullName",
    "        } else {",
    "            # Check if kvcache contents are directly in $dir (Scoop extracted directly)",
    "            # Look for inference_phison, maestro_phison, or phison.lock.bin.* files",
    "            $inferencePhison = Join-Path $dir 'inference_phison'",
    "            $maestroPhison = Join-Path $dir 'maestro_phison'",
    "            $phisonLockBin = Get-ChildItem -Path $dir -File -Filter 'phison.lock.bin.*' | Select-Object -First 1",
    "            ",
    "            if ((Test-Path $inferencePhison) -or (Test-Path $maestroPhison) -or $phisonLockBin) {",
    "                # Contents are directly in $dir, use $dir as source",
    "                $sourcePath = $dir",
    "            } else {",
    "                Write-Warning 'SillyTavern_kvcache.zip not found and no extracted directory found. Skipping kvcache extraction.'",
    "            }",
    "        }",
    "    }",
    "",
    "    # Move kvcache contents to R drive root",
    "    if ($sourcePath) {",
    "        try {",
    "            if ($sourcePath -eq $dir) {",
    "                # Contents are directly in $dir, move only kvcache items",
    "                $itemsToMove = @()",
    "                $inferencePhison = Join-Path $dir 'inference_phison'",
    "                $maestroPhison = Join-Path $dir 'maestro_phison'",
    "                $phisonLockBinFiles = Get-ChildItem -Path $dir -File -Filter 'phison.lock.bin.*'",
    "                ",
    "                if (Test-Path $inferencePhison) { $itemsToMove += Get-Item $inferencePhison }",
    "                if (Test-Path $maestroPhison) { $itemsToMove += Get-Item $maestroPhison }",
    "                if ($phisonLockBinFiles) { $itemsToMove += $phisonLockBinFiles }",
    "                ",
    "                foreach ($item in $itemsToMove) {",
    "                    $targetItemPath = Join-Path $rDriveRoot $item.Name",
    "                    if (Test-Path $targetItemPath) {",
    "                        if ($item.PSIsContainer) {",
    "                            Remove-Item -Path $targetItemPath -Recurse -Force -ErrorAction SilentlyContinue",
    "                        } else {",
    "                            Remove-Item -Path $targetItemPath -Force -ErrorAction SilentlyContinue",
    "                        }",
    "                    }",
    "                    Move-Item -Path $item.FullName -Destination $targetItemPath -Force",
    "                    Write-Host \"Moved $($item.Name) to R:\\\"",
    "                }",
    "            } else {",
    "                # Contents are in a subdirectory, move all items",
    "                $items = Get-ChildItem -Path $sourcePath",
    "                foreach ($item in $items) {",
    "                    $targetItemPath = Join-Path $rDriveRoot $item.Name",
    "                    if (Test-Path $targetItemPath) {",
    "                        if ($item.PSIsContainer) {",
    "                            Remove-Item -Path $targetItemPath -Recurse -Force -ErrorAction SilentlyContinue",
    "                        } else {",
    "                            Remove-Item -Path $targetItemPath -Force -ErrorAction SilentlyContinue",
    "                        }",
    "                    }",
    "                    Move-Item -Path $item.FullName -Destination $targetItemPath -Force",
    "                    Write-Host \"Moved $($item.Name) to R:\\\"",
    "                }",
    "            }",
    "            Write-Host 'SillyTavern_kvcache contents moved to R:\\'",
    "        } catch {",
    "            Write-Warning \"Failed to move kvcache contents to R drive: $_\"",
    "        } finally {",
    "            # Clean up temp directory if it was created",
    "            if ($tempExtractPath -and (Test-Path $tempExtractPath)) {",
    "                Remove-Item -Path $tempExtractPath -Recurse -Force -ErrorAction SilentlyContinue",
    "            }",
    "            # Clean up extracted directory if it was created by Scoop (only if empty)",
    "            if ($sourcePath -and $sourcePath -ne $tempExtractPath -and $sourcePath -ne $dir) {",
    "                $extractedDir = Get-Item -Path $sourcePath -ErrorAction SilentlyContinue",
    "                if ($extractedDir -and $extractedDir.PSIsContainer) {",
    "                    try {",
    "                        $remainingItems = Get-ChildItem -Path $sourcePath -ErrorAction SilentlyContinue",
    "                        if (-not $remainingItems) {",
    "                            Remove-Item -Path $sourcePath -Recurse -Force -ErrorAction SilentlyContinue",
    "                        }",
    "                    } catch {",
    "                        # Ignore cleanup errors",
    "                    }",
    "                }",
    "            }",
    "        }",
    "    }",
    "}"
  ],
  "pre_uninstall": [
    "# Stop SillyTavern service before uninstall",
    "if (Test-Path \"$dir\\stop.ps1\") {",
    "    & \"$dir\\stop.ps1\" | Out-Null",
    "    Start-Sleep -Seconds 2",
    "}",
    "",
    "# Remove status.ps1 to avoid file lock issues",
    "if (Test-Path \"$dir\\status.ps1\") {",
    "    Remove-Item -Path \"$dir\\status.ps1\" -Force -ErrorAction SilentlyContinue",
    "}",
    "",
    "# Clean up external data directories (kvcache on R drive)",
    "if (Test-Path 'R:\\inference_phison\\SillyTavern_kvcache') {",
    "    Remove-Item -Path 'R:\\inference_phison\\SillyTavern_kvcache' -Recurse -Force -ErrorAction SilentlyContinue",
    "}"
  ]
}

