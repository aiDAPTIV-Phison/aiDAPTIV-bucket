{
  "version": "v0.0.2",
  "description": "Open WebUI is an extensible, feature-rich, and user-friendly self-hosted AI platform designed to operate entirely offline. It supports various LLM runners like Ollama and OpenAI-compatible APIs, with built-in inference engine for RAG, making it a powerful AI deployment solution.",
  "homepage": "https://github.com/aiDAPTIV-Phison/aiDAPTIV-Integration-open-webui",
  "url": [
    "https://github.com/aiDAPTIV-Phison/aiDAPTIV-bucket/raw/refs/heads/main/open_webui/start.ps1",
    "https://github.com/aiDAPTIV-Phison/aiDAPTIV-bucket/raw/refs/heads/main/open_webui/stop.ps1",
    "https://github.com/aiDAPTIV-Phison/aiDAPTIV-bucket/raw/refs/heads/main/open_webui/status.ps1",
    "https://github.com/aiDAPTIV-Phison/aiDAPTIV-bucket/raw/refs/heads/main/open_webui/config.txt",
    "http://192.168.54.46:18301/open-webui.zip",
    "http://192.168.54.46:18301/open-webui_default_collection_kvcache/open-webui_default_collection.zip",
    "http://192.168.54.46:18301/open-webui_default_collection_kvcache/openwebui_default_kv_cache.zip"
  ],
  "depends": ["python311"],
  "installer": {
    "script": [
      "$openWebuiDir = Join-Path $dir 'open-webui'",
      "$zipDest = Join-Path $dir 'open-webui.zip'",
      "Write-Host '[INFO] Checking for uv...'",
      "$uvCheck = Get-Command uv -ErrorAction SilentlyContinue",
      "if (-not $uvCheck) {",
      "  Write-Host '[INFO] uv not found, installing uv...'",
      "  python -m pip install uv",
      "  if ($LASTEXITCODE -ne 0) {",
      "    Write-Error 'Failed to install uv'",
      "    exit 1",
      "  }",
      "  Write-Host '[INFO] uv installed successfully'",
      "} else {",
      "  Write-Host '[INFO] uv is already installed'",
      "}",
      "Write-Host '[INFO] Setting up backend virtual environment...'",
      "$backendPath = Join-Path $dir 'backend'",
      "$backendVenv = Join-Path $backendPath 'venv_open_webui'",
      "if (-not (Test-Path $backendVenv)) {",
      "  Write-Host '[INFO] Virtual environment not found, creating new one...'",
      "  python311 -m venv $backendVenv",
      "  if ($LASTEXITCODE -ne 0) {",
      "    Write-Error 'Failed to create venv_open_webui'",
      "    exit 1",
      "  }",
      "  Write-Host '[INFO] Virtual environment created'",
      "} else {",
      "  Write-Host '[INFO] Virtual environment already exists, will update dependencies'",
      "}",
      "Write-Host '[INFO] Checking and installing backend requirements...'",
      "$backendActivate = Join-Path $backendVenv 'Scripts\\Activate.ps1'",
      "& $backendActivate",
      "$requirementsTxt = Join-Path $backendPath 'requirements.txt'",
      "if (Test-Path $requirementsTxt) {",
      "  Write-Host '[INFO] Installing from requirements.txt...'",
      "  pip install -r $requirementsTxt",
      "} else {",
      "  Write-Warning 'No requirements.txt found in backend'",
      "}",
      "deactivate",
      "Write-Host '[INFO] Backend setup completed'",
      "Write-Host '[INFO] Setting up km virtual environment...'",
      "$kmPath = Join-Path $dir 'km'",
      "$kmVenv = Join-Path $kmPath 'venv_km'",
      "if (-not (Test-Path $kmVenv)) {",
      "  Write-Host '[INFO] Virtual environment not found, creating new one...'",
      "  python311 -m venv $kmVenv",
      "  if ($LASTEXITCODE -ne 0) {",
      "    Write-Error 'Failed to create venv_km'",
      "    exit 1",
      "  }",
      "  Write-Host '[INFO] Virtual environment created'",
      "} else {",
      "  Write-Host '[INFO] Virtual environment already exists, will update dependencies'",
      "}",
      "Write-Host '[INFO] Checking and installing km requirements...'",
      "$kmActivate = Join-Path $kmVenv 'Scripts\\Activate.ps1'",
      "& $kmActivate",
      "$kmRequirementsTxt = Join-Path $kmPath 'requirements.txt'",
      "if (Test-Path $kmRequirementsTxt) {",
      "  Write-Host '[INFO] Installing from requirements.txt...'",
      "  pip install -r $kmRequirementsTxt",
      "} else {",
      "  Write-Warning 'No requirements.txt found in km'",
      "}",
      "deactivate",
      "Write-Host '[INFO] km setup completed'"
    ]
  },
  "post_install": [
    "Write-Host '[INFO] Testing Open WebUI installation...'",
    "Write-Host '[INFO] Starting Open WebUI...'",
    "& (Join-Path $dir 'start.ps1') -OpenBrowser $false",
    "Write-Host '[INFO] Waiting for services to initialize...'",
    "Start-Sleep -Seconds 10",
    "Write-Host '[INFO] Waiting for service to start...'",
    "$isRunning = $false",
    "$maxAttempts = 60",
    "$attempt = 0",
    "while (-not $isRunning -and $attempt -lt $maxAttempts) {",
    "  $attempt++",
    "  Start-Sleep -Seconds 2",
    "  try {",
    "    $statusScript = Join-Path $dir 'status.ps1'",
    "    if (Test-Path $statusScript) {",
    "      $statusOutput = & $statusScript -ScriptDir $dir 2>$null | Out-String",
    "      $statusOutput = $statusOutput.Trim()",
    "      Write-Host \"[INFO] Attempt ${attempt}/${maxAttempts}: $statusOutput\"",
    "      if ($statusOutput) {",
    "        $statusJson = $statusOutput | ConvertFrom-Json -ErrorAction Stop",
    "        if ($statusJson.PSObject.Properties.Name -contains 'status' -and [int]$statusJson.status -eq 1) {",
    "          $isRunning = $true",
    "          Write-Host '[SUCCESS] Open WebUI is running!'",
    "        }",
    "      }",
    "    } else {",
    "      Write-Warning 'status.ps1 not found'",
    "    }",
    "  } catch {",
    "    Write-Host \"[DEBUG] Error checking status: $_\"",
    "  }",
    "}",
    "if (-not $isRunning) {",
    "  Write-Warning 'Service did not start within expected time, but continuing with installation...'",
    "}",
    "Write-Host '[INFO] Service started successfully, now stopping...'",
    "& (Join-Path $dir 'stop.ps1')",
    "Write-Host '[INFO] Service stopped'",
    "Write-Host '[INFO] Installation test completed'",
    "Write-Host '[INFO] Copying open-webui_default_collection contents to $dir...'",
    "if (Test-Path (Join-Path $dir 'open-webui_default_collection')) {",
    "  Copy-Item -Path (Join-Path $dir 'open-webui_default_collection\\*') -Destination $dir -Recurse -Force -ErrorAction Stop",
    "  Write-Host '[SUCCESS] open-webui_default_collection contents copied'",
    "} else {",
    "  Write-Warning 'open-webui_default_collection folder not found'",
    "}",
    "Write-Host '[INFO] Copying openwebui_default_kv_cache to R:\\inference_phison...'",
    "if (Test-Path (Join-Path $dir 'openwebui_default_kv_cache')) {",
    "  Copy-Item -Path (Join-Path $dir 'openwebui_default_kv_cache') -Destination 'R:\\inference_phison' -Recurse -Force -ErrorAction Stop",
    "  Write-Host '[SUCCESS] openwebui_default_kv_cache copied to R:\\inference_phison'",
    "} else {",
    "  Write-Warning 'openwebui_default_kv_cache folder not found'",
    "}"
  ],
  "pre_uninstall": [
    "Write-Host '[INFO] Stopping services...'",
    "& (Join-Path $dir 'stop.ps1')",
    "Write-Host '[INFO] Waiting for services to fully stop...'",
    "Start-Sleep -Seconds 5",
    "Write-Host '[INFO] Checking for processes using $dir...'",
    "$maxAttempts = 3",
    "for ($i = 1; $i -le $maxAttempts; $i++) {",
    "  $processes = Get-Process | Where-Object {",
    "    try {",
    "      $_.Path -and $_.Path.StartsWith($dir)",
    "    } catch {",
    "      $false",
    "    }",
    "  }",
    "  $pythonProcesses = Get-Process python*, uvicorn* -ErrorAction SilentlyContinue | Where-Object {",
    "    try {",
    "      $cmdLine = (Get-CimInstance Win32_Process -Filter \"ProcessId = $($_.Id)\").CommandLine",
    "      $cmdLine -and $cmdLine.Contains($dir)",
    "    } catch {",
    "      $false",
    "    }",
    "  }",
    "  $allProcesses = @($processes) + @($pythonProcesses) | Select-Object -Unique",
    "  if ($allProcesses.Count -gt 0) {",
    "    Write-Host \"[WARNING] Found $($allProcesses.Count) process(es) still using $dir (Attempt ${i}/${maxAttempts})\"",
    "    foreach ($proc in $allProcesses) {",
    "      try {",
    "        Write-Host \"[INFO] Killing process: $($proc.Name) (PID: $($proc.Id))\"",
    "        Stop-Process -Id $proc.Id -Force -ErrorAction Stop",
    "      } catch {",
    "        Write-Warning \"Failed to kill process $($proc.Id): $_\"",
    "      }",
    "    }",
    "    if ($i -lt $maxAttempts) {",
    "      Write-Host '[INFO] Waiting for processes to terminate...'",
    "      Start-Sleep -Seconds 3",
    "    }",
    "  } else {",
    "    Write-Host '[INFO] No processes found using $dir'",
    "    break",
    "  }",
    "}",
    "Write-Host '[INFO] Final cleanup wait...'",
    "Start-Sleep -Seconds 2",
    "[System.GC]::Collect()",
    "[System.GC]::WaitForPendingFinalizers()",
    "if (Test-Path \"$dir\\status.ps1\") {",
    "  Remove-Item -Path \"$dir\\status.ps1\" -Force -ErrorAction SilentlyContinue",
    "}",
    "Write-Host '[INFO] Pre-uninstall cleanup completed'"
  ]
}
